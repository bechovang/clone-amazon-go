# File: auto_calibrate.py - PhiÃªn báº£n tá»± Ä‘á»™ng khÃ´ng cáº§n input
from machine import Pin
from hx711 import HX711
import time

# Cáº¥u hÃ¬nh chÃ¢n káº¿t ná»‘i (Ä‘Ã£ sá»­a theo cÃ¡ch káº¿t ná»‘i cá»§a báº¡n)
DT_PIN = 4   # ESP32 D4 â†’ HX711 DT (DOUT)
SCK_PIN = 5  # ESP32 D5 â†’ HX711 SCK (PD_SCK)

# Khá»Ÿi táº¡o HX711
hx = HX711(d_out=DT_PIN, pd_sck=SCK_PIN)

print("ğŸ”§ Báº®T Äáº¦U HIá»†U CHUáº¨N CÃ‚N")
print("Äang khá»Ÿi táº¡o... Äá»£i 3 giÃ¢y")
time.sleep(3)

# BÆ¯á»šC 1: Äo giÃ¡ trá»‹ khi khÃ´ng cÃ³ gÃ¬ trÃªn cÃ¢n
print("\n" + "="*40)
print("BÆ¯á»šC 1: ÄANG ÄO GIÃ TRá»Š BÃŒ (TARE)...")
print("Äáº£m báº£o cÃ¢n trá»‘ng!")

tare_readings = []
for i in range(5):
    reading = hx.read()
    tare_readings.append(reading)
    print(f"Láº§n Ä‘o {i+1}: {reading}")
    time.sleep(1)

tare_value = sum(tare_readings) // len(tare_readings)
print(f"ğŸ“ GIÃ TRá»Š BÃŒ (TARE): {tare_value}")

# BÆ¯á»šC 2: Äo giÃ¡ trá»‹ khi cÃ³ váº­t chuáº©n
print("\n" + "="*40)
print("BÆ¯á»šC 2: ÄANG ÄO GIÃ TRá»Š KHI CÃ“ Váº¬T...")
print("Äáº·t váº­t cÃ³ trá»ng lÆ°á»£ng biáº¿t chÃ­nh xÃ¡c lÃªn cÃ¢n!")
print("VÃ­ dá»¥: chai nÆ°á»›c 500ml = 500g")
print("Chá» 10 giÃ¢y Ä‘á»ƒ báº¡n Ä‘áº·t váº­t lÃªn cÃ¢n...")

# Äá»£i 10 giÃ¢y Ä‘á»ƒ ngÆ°á»i dÃ¹ng Ä‘áº·t váº­t lÃªn cÃ¢n
for i in range(10, 0, -1):
    print(f"CÃ²n {i} giÃ¢y...")
    time.sleep(1)

weight_readings = []
for i in range(5):
    reading = hx.read()
    weight_readings.append(reading)
    print(f"Láº§n Ä‘o {i+1}: {reading}")
    time.sleep(1)

weight_value = sum(weight_readings) // len(weight_readings)
print(f"ğŸ“ GIÃ TRá»Š KHI CÃ“ Váº¬T: {weight_value}")

print("\n" + "="*50)
print("âœ… HIá»†U CHUáº¨N HOÃ€N Táº¤T!")
print("Ghi láº¡i 2 giÃ¡ trá»‹ sau Ä‘á»ƒ dÃ¹ng cho bÆ°á»›c tiáº¿p theo:")
print(f"TARE_VALUE = {tare_value}")
print(f"VALUE_WITH_WEIGHT = {weight_value}")
print("="*50)

# Tá»± Ä‘á»™ng táº¡o file config vá»›i cÃ¡c giÃ¡ trá»‹ Ä‘Ã£ hiá»‡u chuáº©n
config_content = f"""# Cáº¥u hÃ¬nh tá»± Ä‘á»™ng táº¡o tá»« quÃ¡ trÃ¬nh hiá»‡u chuáº©n
TARE_VALUE = {tare_value}
VALUE_WITH_WEIGHT = {weight_value}
KNOWN_WEIGHT_G = 500  # Thay Ä‘á»•i náº¿u báº¡n dÃ¹ng váº­t chuáº©n khÃ¡c
RATIO = (VALUE_WITH_WEIGHT - TARE_VALUE) / KNOWN_WEIGHT_G
"""

with open('config.py', 'w') as f:
    f.write(config_content)
    
print("ÄÃ£ táº¡o file config.py vá»›i cÃ¡c giÃ¡ trá»‹ hiá»‡u chuáº©n!")